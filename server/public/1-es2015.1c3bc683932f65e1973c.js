(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{EdD2:function(t,e,s){"use strict";s.r(e);var i=s("ofXK"),n=s("fXoL"),a=s("tyNb"),c=s("WnqB"),r=s("pfAz"),o=s("tk/3"),l=s("vFID");let h=(()=>{class t extends r.a{constructor(t,e){super(t,e)}list(){return this.get("chat/list",{}).then(t=>(console.log("ChatDataService -> list -> response",t),Promise.resolve(t))).catch(t=>(console.log("ChatDataService -> list -> err",{err:t}),Promise.reject([])))}listChannels(){return this.get("chat/channels",{}).then(t=>(console.log("ChatDataService -> list -> response",t),Promise.resolve(t))).catch(t=>(console.log("ChatDataService -> list -> err",{err:t}),Promise.reject([])))}getChannel(t){return this.get(`chat/get/${t}`,{}).then(t=>Promise.resolve(t)).catch(t=>(console.log("ChatDataService -> getChat -> err",{err:t}),Promise.reject([])))}getChat(t){return this.get(`chat/with/${t}`,{}).then(t=>Promise.resolve(t)).catch(t=>(console.log("ChatDataService -> getChat -> err",{err:t}),Promise.reject([])))}messagesFromChat(t){return this.get(`chat/${t.id}/messages`,{}).then(t=>Promise.resolve(t)).catch(t=>(console.log("ChatDataService -> messagesFromChat -> err",{err:t}),Promise.reject([])))}newMessage(t,e){const s=Object.assign(Object.assign({},e),{date:Date.now()});return this.post(`chat/${t}/message`,{message:s}).then(t=>Promise.resolve(t)).catch(t=>(console.log("newMessage -> err",t),Promise.reject()))}update(t){const{id:e,name:s,nicknames:i}=t;return this.post(`chat/update/${e}`,{name:s,nicknames:i}).then(t=>Promise.resolve(t)).catch(t=>(console.log("ChatDataService -> update -> err",{err:t}),Promise.reject([])))}joinToChat(t,e){const{id:s,nicknames:i}=t;return this.update({id:s,nicknames:[...i,e]})}}return t.\u0275fac=function(e){return new(e||t)(n.Rb(o.a),n.Rb(l.a))},t.\u0275prov=n.Fb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})();function b(t,e){if(1&t&&(n.Nb(0,"div",3),n.kc(1),n.Mb()),2&t){const t=n.Xb();n.zb(1),n.lc(t.text)}}function m(t,e){if(1&t&&(n.Nb(0,"div",4),n.kc(1),n.Mb()),2&t){const t=n.Xb();n.zb(1),n.lc(t.text)}}function u(t,e){1&t&&n.Lb(0)}function f(t,e){if(1&t&&n.ic(0,u,1,0,"ng-container",5),2&t){n.Xb();const t=n.ec(1);n.ac("ngTemplateOutlet",t)}}let g=(()=>{class t{constructor(){this.text="",this.notMine=!0}ngOnInit(){}}return t.\u0275fac=function(e){return new(e||t)},t.\u0275cmp=n.Db({type:t,selectors:[["chat-message"]],inputs:{text:"text",notMine:"notMine"},decls:5,vars:2,consts:[["messageTpl",""],["myMessageTpl",""],[3,"ngIf","ngIfElse"],[1,"inline-block","whitespace-pre-wrap","my-1","px-2","py-1","bg-gray-200","rounded-md","text-gray-800","leading-tight","sm:max-w-md"],[1,"inline-block","whitespace-pre-wrap","my-1","px-2","py-1","bg-green-200","rounded-md","text-gray-800","leading-tight","text-right","sm:max-w-md"],[4,"ngTemplateOutlet"]],template:function(t,e){if(1&t&&(n.ic(0,b,2,1,"ng-template",null,0,n.jc),n.ic(2,m,2,1,"ng-template",null,1,n.jc),n.ic(4,f,1,1,"ng-template",2)),2&t){const t=n.ec(3);n.zb(4),n.ac("ngIf",e.notMine)("ngIfElse",t)}},directives:[i.j,i.k],encapsulation:2}),t})(),d=(()=>{class t{transform(t,{prop:e,sep:s}){return e||(e="name"),s||(s="|"),t.map(t=>t[e]).join(s)}}return t.\u0275fac=function(e){return new(e||t)},t.\u0275pipe=n.Ib({name:"map_join",type:t,pure:!0}),t})();const p=["lastDiv"];function v(t,e){if(1&t&&(n.Nb(0,"div",3),n.Kb(1,"img",4),n.Nb(2,"div"),n.Nb(3,"h2",5),n.kc(4),n.Mb(),n.Nb(5,"div",6),n.kc(6),n.Mb(),n.Mb(),n.Mb()),2&t){const t=n.Xb();n.zb(1),n.ac("src",t.chat.participants[1].image,n.gc),n.zb(3),n.lc(t.chat.participants[1].fullName),n.zb(2),n.mc("@",t.chat.participants[1].nickname,"")}}const M=function(){return{prop:"nickname",sep:", "}};function k(t,e){if(1&t&&(n.Nb(0,"div",7),n.Nb(1,"div"),n.Nb(2,"div",8),n.kc(3),n.Mb(),n.Nb(4,"div",9),n.Nb(5,"div",10),n.kc(6),n.Mb(),n.Nb(7,"div",11),n.kc(8),n.Yb(9,"map_join"),n.Mb(),n.Mb(),n.Mb(),n.Mb()),2&t){const t=n.Xb();n.zb(3),n.mc("#",t.chat.name,""),n.zb(3),n.lc(t.chat.participants.length),n.zb(2),n.lc(n.Zb(9,3,t.chat.participants,n.bc(6,M)))}}function w(t,e){1&t&&n.Lb(0)}function y(t,e){if(1&t&&n.ic(0,w,1,0,"ng-container",24),2&t){n.Xb(2);const t=n.ec(3);n.ac("ngTemplateOutlet",t)}}function x(t,e){if(1&t&&n.Kb(0,"img",32),2&t){const t=n.Xb().$implicit,e=n.Xb(2);n.ac("src",e.chat.user[t.from].image,n.gc)}}const C=function(t){return{"justify-end":t}};function N(t,e){if(1&t&&(n.Nb(0,"div",33),n.Kb(1,"chat-message",34),n.Mb()),2&t){const t=e.$implicit,s=n.Xb().$implicit,i=n.Xb(2);n.ac("ngClass",n.cc(3,C,s.from===i.me.id)),n.zb(1),n.ac("notMine",s.from!==i.me.id)("text",t.text)}}const j=function(t){return{"w-16":t}};function S(t,e){if(1&t&&(n.Nb(0,"div",25),n.Nb(1,"div",9),n.Nb(2,"div",26),n.ic(3,x,1,1,"img",27),n.Mb(),n.Nb(4,"div",19),n.Nb(5,"div",28),n.Nb(6,"div",29),n.kc(7),n.Mb(),n.Mb(),n.Nb(8,"div",30),n.ic(9,N,2,5,"div",31),n.Mb(),n.Mb(),n.Mb(),n.Mb()),2&t){const t=e.$implicit,s=n.Xb(2);n.zb(2),n.ac("ngClass",n.cc(5,j,t.from===s.me.id)),n.zb(1),n.ac("ngIf",s.chat.isChannel&&t.from!==s.me.id),n.zb(2),n.ac("ngClass",n.cc(7,C,t.from===s.me.id)),n.zb(2),n.lc(s.chat.user[t.from].fullName),n.zb(2),n.ac("ngForOf",t.messages)}}function z(t,e){if(1&t){const t=n.Ob();n.Nb(0,"div",12),n.Nb(1,"div",13),n.Nb(2,"div",14),n.ic(3,y,1,1,"ng-template",15),n.Nb(4,"div",16),n.Nb(5,"div",17),n.Nb(6,"div",18),n.Nb(7,"div",19),n.ic(8,S,10,9,"div",20),n.Mb(),n.Mb(),n.Mb(),n.Nb(9,"div",21,22),n.Nb(11,"textarea",23),n.Vb("keyup.enter",(function(e){return n.fc(t),n.Xb().newMessage(e.target)}))("input",(function(e){return n.fc(t),n.Xb().typing=e.target.value})),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb()}if(2&t){const t=n.Xb(),e=n.ec(1);n.zb(3),n.ac("ngIf",t.chat.isChannel)("ngIfElse",e),n.zb(5),n.ac("ngForOf",t.chat.messages.blocks),n.zb(3),n.ac("value",t.typing)("disabled",t.isSendingMessage)}}const B=function(t){return["/chat/channel",t]};function D(t,e){if(1&t&&(n.Nb(0,"li",39),n.Nb(1,"h2",40),n.kc(2),n.Mb(),n.Nb(3,"div",41),n.kc(4),n.Yb(5,"map_join"),n.Mb(),n.Mb()),2&t){const t=e.$implicit;n.ac("routerLink",n.cc(7,B,t.id)),n.zb(2),n.nc("",t.isChannel?"#":"","",t.name,""),n.zb(2),n.mc("with: ",n.Zb(5,4,t.participants,n.bc(9,M)),"")}}function I(t,e){if(1&t){const t=n.Ob();n.Nb(0,"div",12),n.Nb(1,"div",13),n.Nb(2,"div",14),n.Nb(3,"div",35),n.Nb(4,"div",5),n.kc(5,"chats"),n.Mb(),n.Nb(6,"input",36),n.Vb("input",(function(e){return n.fc(t),n.Xb().filterInput(e.target.value)})),n.Mb(),n.Mb(),n.Nb(7,"div",16),n.Nb(8,"div",17),n.Nb(9,"div",18),n.Nb(10,"div",19),n.Nb(11,"div",25),n.Nb(12,"ul",37),n.ic(13,D,6,10,"li",38),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb(),n.Mb()}if(2&t){const t=n.Xb();n.zb(13),n.ac("ngForOf",t.filteredData)}}let P=(()=>{class t{constructor(t,e,s,i){this.route=t,this.chatSocketEvt=e,this.chatPersistenceService=s,this.typing="",this.isSendingMessage=!1,this.me=i.get("user")}ngOnInit(){this.clearData(),this.paramSubscriber=this.route.params.subscribe(t=>{const e=t.nickname;if(e)return this.queryChat(e);const s=t.channelId;if(s)switch(s){case"all":return this.dataChat=null,this.chatPersistenceService.listChannels().then(t=>{this.data=t.chatList});default:return this.data=null,this.queryGroup(s)}return this.chatPersistenceService.list().then(t=>{this.data=t.chatList})})}clearData(){this.dataSource=null,this.filter=null,this.filteredData=null,this.chat=null}queryGroup(t){this.chatPersistenceService.getChannel(t).then(this.loadChat.bind(this))}queryChat(t){this.chatPersistenceService.getChat(t).then(this.loadChat.bind(this))}loadChat(t){const e=t.chat;this.chatPersistenceService.messagesFromChat(e).then(t=>{const s=(t.messageList||[]).reduce((t,e)=>t.firstBlock?(t.firstBlock.from===e.from?t.firstBlock.messages=[e,...t.firstBlock.messages]:(t.firstBlock={from:e.from,messages:[e]},t.blocks=[t.firstBlock,...t.blocks]),t):(t.firstBlock={from:e.from,messages:[e]},t.lastBlock=t.firstBlock,t.blocks=[t.firstBlock],t),{lastBlock:null,firstBlock:null,blocks:[]});this.dataChat=Object.assign(Object.assign({},e),{messages:s}),this.joinMessages(this.chat)})}set data(t){this.dataSource=t,t&&t.length>0&&(this.chatSocketEvt.joinToChatRooms(this.dataSource,this.me.id),this.dataSource.forEach(t=>{this.chatSocketEvt.onChatMessage(t,this.joinMessages.bind(this))})),this.filterInput(this.filter)}filterInput(t){console.log("filterInput -> str",t),this.query(t?{name:t}:null)}query(t){if(!t)return this.filteredData=this.dataSource;this.filteredData=this.dataSource.filter(e=>{for(const s in t)if(t.hasOwnProperty(s)){const i=e[s];if("string"==typeof i&&i.toLowerCase().indexOf(t[s].toLowerCase())>=0)return e;if(i===t[s])return e}return null})}set dataChat(t){this.chat=t,t&&(this.chat.user=this.chat.participants.reduce((t,e)=>(t[e.id]=e,t),{}),this.chatSocketEvt.joinToChatRooms([this.chat],this.me.id),this.chatSocketEvt.onChatMessage(this.chat,(t=>{this.joinMessages(t)}).bind(this)))}joinMessages(t){t.messages=t.messages||{};for(const e of t.newMessages||[])e.isOld||(e.isOld=!0,t.messages.lastBlock||(t.messages.firstBlock={from:e.from,messages:[e]},t.messages.lastBlock=t.messages.firstBlock,t.messages.blocks=[t.messages.firstBlock]),t.messages.lastBlock.from===e.from?t.messages.lastBlock.messages.push(e):(t.messages.lastBlock={from:e.from,messages:[e]},t.messages.blocks.push(t.messages.lastBlock)));this.scrollBottom()}ngAfterViewInit(){this.scrollBottom()}scrollBottom(){setTimeout(()=>{try{console.log("--------bottom",this.lastDiv.nativeElement.offsetTop),window.scroll({top:this.lastDiv.nativeElement.offsetTop,behavior:"smooth"})}catch(t){this.scrollBottom()}},300)}newMessage(t){this.isSendingMessage=!0,this.chatPersistenceService.newMessage(this.chat.id,{from:this.me.id,text:this.typing}).then(e=>{this.typing="",this.isSendingMessage=!1,setTimeout(()=>{t.focus()},1)}).catch(t=>{console.log("ChatComponent -> newMessage -> err",t),this.typing="",this.isSendingMessage=!1})}ngOnDestroy(){this.paramSubscriber.unsubscribe(),this.chatSocketEvt.unsubscribe()}}return t.\u0275fac=function(e){return new(e||t)(n.Jb(a.a),n.Jb(c.a),n.Jb(h),n.Jb(l.a))},t.\u0275cmp=n.Db({type:t,selectors:[["app-chat"]],viewQuery:function(t,e){var s;1&t&&n.oc(p,!0),2&t&&n.dc(s=n.Wb())&&(e.lastDiv=s.first)},decls:6,vars:2,consts:[["directMessageProfile",""],["groupProfile",""],["class","h-full text-gray-900",4,"ngIf"],[1,"p-4","flex","items-center","shadow","sticky","top-0","bg-white"],[1,"w-10","h-10","md:h-16","md:w-16","rounded-full","mr-2",3,"src"],[1,"font-medium","leading-none","capitalize"],[1,"text-gray-600","text-xs","leading-none"],[1,"p-4","flex","justify-between","items-end","shadow","sticky","top-0","bg-white"],[1,"font-medium"],[1,"flex"],[1,"text-sm","text-gray-700","font-normal","px-2","border-r-2"],[1,"text-sm","text-gray-700","font-normal","px-2"],[1,"h-full","text-gray-900"],[1,"h-full"],[1,"h-full","flex","flex-col"],[3,"ngIf","ngIfElse"],[1,"flex-1","flex","flex-col"],[1,"px-4","flex-1"],[1,"flex","flex-col"],[1,"flex-1"],["class","my-2",4,"ngFor","ngForOf"],[1,"bg-white","px-3","sticky","inset-0","mt-2"],["lastDiv",""],["name","chatting-area","placeholder","Type your message here",1,"w-full","p-2","text-sm","text-gray-800","rounded-md","border","resize-none","focus:outline-none","focus:shadow",3,"value","disabled","keyup.enter","input"],[4,"ngTemplateOutlet"],[1,"my-2"],[1,"mr-3","w-16",3,"ngClass"],["class","w-10 h-10 md:h-16 md:w-16 object-cover rounded-full",3,"src",4,"ngIf"],[1,"ml-1","flex","items-end","justify-end",3,"ngClass"],[1,"font-medium","mr-2","leading-none","capitalize"],[1,"text-sm"],["class","flex justify-end",3,"ngClass",4,"ngFor","ngForOf"],[1,"w-10","h-10","md:h-16","md:w-16","object-cover","rounded-full",3,"src"],[1,"flex","justify-end",3,"ngClass"],[3,"notMine","text"],[1,"p-4"],["name","filter","placeholder","Search by chat name or nickname","type","search",1,"w-full","p-2","mt-2","text-lg","text-gray-800","rounded-md","border","resize-none","focus:outline-none","focus:shadow",3,"input"],[1,""],["class","p-1 bg-white m-1 rounded cursor-pointer shadow",3,"routerLink",4,"ngFor","ngForOf"],[1,"p-1","bg-white","m-1","rounded","cursor-pointer","shadow",3,"routerLink"],[1,"text-lg"],[1,"text-sm","text-gray-500"]],template:function(t,e){1&t&&(n.ic(0,v,7,3,"ng-template",null,0,n.jc),n.ic(2,k,10,7,"ng-template",null,1,n.jc),n.ic(4,z,12,5,"div",2),n.ic(5,I,14,1,"div",2)),2&t&&(n.zb(4),n.ac("ngIf",e.chat),n.zb(1),n.ac("ngIf",e.dataSource))},directives:[i.j,i.i,i.k,i.h,g,a.c],pipes:[d],encapsulation:2}),t})();const O=[{path:"",component:P},{path:"with/:nickname",component:P},{path:"channel/:channelId",component:P}];let X=(()=>{class t{}return t.\u0275mod=n.Hb({type:t}),t.\u0275inj=n.Gb({factory:function(e){return new(e||t)},imports:[[a.e.forChild(O)],a.e]}),t})();var E=s("aYsj");s.d(e,"ChatModule",(function(){return F}));let F=(()=>{class t{}return t.\u0275mod=n.Hb({type:t}),t.\u0275inj=n.Gb({factory:function(e){return new(e||t)},imports:[[i.b,X,E.a]]}),t})()}}]);